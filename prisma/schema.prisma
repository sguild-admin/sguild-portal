generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                      String          @id @default(uuid()) @db.Uuid
  clerkOrgId              String          @unique
  name                    String
  primaryAdminClerkUserId String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  members                 OrgMembership[]
  invitations             OrgInvitation[]

  @@index([primaryAdminClerkUserId])
}

model AppUser {
  id           String   @id @default(uuid()) @db.Uuid
  clerkUserId  String   @unique @db.Text

  primaryEmail String?  @db.Text
  firstName    String?  @db.Text
  lastName     String?  @db.Text
  displayName  String?  @db.Text
  phone        String?  @db.Text

  isDisabled   Boolean  @default(false)

  lastSignInAt DateTime?
  lastSeenAt   DateTime?

  coachProfile CoachProfile?
  memberships  OrgMembership[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model OrgMembership {
  id          String           @id @default(uuid()) @db.Uuid
  orgId       String           @db.Uuid
  clerkUserId String
  role        OrgRole
  status      MembershipStatus @default(ACTIVE)
  invitedAt   DateTime?
  activatedAt DateTime?
  disabledAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  org         Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  appUser     AppUser          @relation(fields: [clerkUserId], references: [clerkUserId], onDelete: Cascade)

  @@unique([orgId, clerkUserId])
  @@index([clerkUserId])
  @@index([orgId, role, status])
}

model CoachProfile {
  id        String   @id @default(uuid()) @db.Uuid
  appUserId String   @unique @db.Uuid
  appUser   AppUser  @relation(fields: [appUserId], references: [id], onDelete: Cascade)

  bio       String?  @db.Text
  notes     String?  @db.Text
  zip       String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WebhookEvent {
  id          String    @id @default(uuid()) @db.Uuid
  provider    String
  eventId     String
  receivedAt  DateTime  @default(now())
  processedAt DateTime?

  @@unique([provider, eventId])
  @@index([provider, receivedAt])
}

model OrgInvitation {
  id                String          @id @default(uuid()) @db.Uuid
  orgId             String          @db.Uuid
  org               Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  clerkInvitationId String          @unique @db.Text
  email             String          @db.Text
  role              String?         @db.Text
  status            OrgInviteStatus @default(PENDING)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  lastSentAt        DateTime?
  expiresAt         DateTime?
  acceptedAt        DateTime?
  revokedAt         DateTime?

  @@index([orgId, email])
  @@index([orgId, status])
}

enum OrgRole {
  ADMIN
  COACH
}

enum MembershipStatus {
  ACTIVE
  DISABLED
}

enum OrgInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}
