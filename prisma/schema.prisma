generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                      String          @id @default(uuid()) @db.Uuid
  clerkOrgId              String          @unique
  name                    String
  primaryAdminClerkUserId String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  members                 OrgMembership[]
  invitations             OrgInvitation[]

  @@index([primaryAdminClerkUserId])
}

model AppUser {
  id          String   @id @default(uuid()) @db.Uuid
  clerkUserId String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OrgMembership {
  id          String           @id @default(uuid()) @db.Uuid
  orgId       String           @db.Uuid
  clerkUserId String
  role        OrgRole
  status      MembershipStatus @default(INVITED)
  invitedAt   DateTime?
  activatedAt DateTime?
  disabledAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  org         Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, clerkUserId])
  @@index([clerkUserId])
  @@index([orgId, role, status])
}

model WebhookEvent {
  id          String    @id @default(uuid()) @db.Uuid
  provider    String
  eventId     String
  receivedAt  DateTime  @default(now())
  processedAt DateTime?

  @@unique([provider, eventId])
  @@index([provider, receivedAt])
}

model OrgInvitation {
  id                String          @id @default(uuid()) @db.Uuid
  orgId             String          @db.Uuid
  org               Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  clerkInvitationId String          @unique @db.Text
  email             String          @db.Text
  role              String?         @db.Text
  status            OrgInviteStatus @default(PENDING)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  lastSentAt        DateTime?
  expiresAt         DateTime?
  acceptedAt        DateTime?
  revokedAt         DateTime?

  @@index([orgId, email])
  @@index([orgId, status])
}

enum OrgRole {
  ADMIN
  COACH
}

enum MembershipStatus {
  INVITED
  ACTIVE
  DISABLED
}

enum OrgInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}
